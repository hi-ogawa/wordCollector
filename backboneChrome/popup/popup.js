// Generated by CoffeeScript 1.9.3
(function() {
  var app;

  app = {};


  /* storage for authentication */

  app.storage = new MyStorage();


  /* before authentication */

  app.loginView = Backbone.View.extend({
    initialize: function() {
      this.$el.html(_.template($("#loginView-t").html())({}));
      this.$("#loginForm input:eq(0)").val("hiogawa@hiogawa.com");
      return this.$("#loginForm input:eq(1)").val("12345678");
    },
    events: {
      "submit #loginForm": function(e) {
        e.preventDefault();
        return Promise.resolve($.ajax({
          url: "http://localhost:3000/api/sessions",
          type: "POST",
          data: this.$("#loginForm").serialize()
        })).then((function(_this) {
          return function(data) {
            return app.storage.update({
              session: data
            });
          };
        })(this))["catch"]((function(_this) {
          return function(err) {
            return app.mainView.renderFlashMessage("wrong email or password");
          };
        })(this));
      },
      "click #register": function(e) {
        return extLib.createTab("http://localhost:9000/login");
      }
    }
  });


  /* after authentication */

  app.authedView = Backbone.View.extend({
    initialize: function(data) {
      console.log(data);
      return this.$el.html(_.template($("#authedView-t").html())(data));
    },
    events: {
      "click #on": function(e) {
        return chrome.tabs.query({
          active: true,
          currentWindow: true
        }, function(tabs) {
          return chrome.tabs.sendMessage(tabs[0].id, {
            type: "popup#appOn"
          });
        });
      },
      "click #off": function(e) {
        return chrome.tabs.query({
          active: true,
          currentWindow: true
        }, function(tabs) {
          return chrome.tabs.sendMessage(tabs[0].id, {
            type: "popup#appOff"
          });
        });
      },
      "click #logout": function(e) {
        return app.storage.clear();
      }
    }
  });


  /* main view */

  app.MainView = Backbone.View.extend({
    initialize: function() {
      $("#flash").hide();
      app.storage.init();
      return app.storage.on("update", (function(_this) {
        return function(data) {
          console.log("-- app.storage update events --");
          console.log(data);
          if ((data != null) && (data.session != null) && (data.session.id != null) && (data.session.auth_token != null)) {
            return Promise.resolve($.ajax({
              url: "http://localhost:3000/api/users/" + data.session.id,
              headers: {
                Authorization: data.session.auth_token
              }
            })).then(function(response) {
              _this.renderFlashMessage("You are already logged in.");
              return _this.renderAuthedView(response.user);
            })["catch"](function(err) {
              console.log(err);
              _this.renderFlashMessage("Previous session is expired. You need to login again.");
              return _this.renderLoginView();
            });
          } else {
            _this.renderFlashMessage("You need to login.");
            return _this.renderLoginView();
          }
        };
      })(this));
    },
    renderLoginView: function() {
      return this.$el.html(new app.loginView().$el);
    },
    renderAuthedView: function(user) {
      return this.$el.html(new app.authedView({
        user: user
      }).$el);
    },
    renderFlashMessage: function(message) {
      return $("#flash").text(message).show();
    }
  });

  app.mainView = null;

  $(function() {
    return app.mainView = new app.MainView({
      el: $("#main")
    });
  });

}).call(this);
